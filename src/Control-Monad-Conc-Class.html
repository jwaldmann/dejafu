<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Control/Monad/Conc/Class.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>-- | This module captures in a typeclass the interface of concurrency</span>
<a name="line-4"></a><span class='hs-comment'>-- monads.</span>
<a name="line-5"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Conc</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span> <span class='hs-keyword'>where</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span> <span class='hs-layout'>(</span><span class='hs-varid'>forkIO</span><span class='hs-layout'>)</span>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span><span class='hs-varop'>.</span><span class='hs-conid'>MVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>readMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newEmptyMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>putMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tryPutMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>takeMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tryTakeMVar</span><span class='hs-layout'>)</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>unless</span><span class='hs-layout'>,</span> <span class='hs-varid'>void</span><span class='hs-layout'>)</span>
<a name="line-10"></a>
<a name="line-11"></a><a name="MonadConc"></a><span class='hs-comment'>-- | @MonadConc@ is like a combination of 'ParFuture' and 'ParIVar'</span>
<a name="line-12"></a><a name="MonadConc"></a><span class='hs-comment'>-- from the abstract-par package. It captures the interface of</span>
<a name="line-13"></a><a name="MonadConc"></a><span class='hs-comment'>-- concurrency monads in terms of how they can operate on shared</span>
<a name="line-14"></a><a name="MonadConc"></a><span class='hs-comment'>-- state.</span>
<a name="line-15"></a><a name="MonadConc"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><a name="MonadConc"></a><span class='hs-comment'>-- There are a few notable differences: firstly, @Par@ imposes</span>
<a name="line-17"></a><a name="MonadConc"></a><span class='hs-comment'>-- 'NFData' constraints on everything, as it achieves its speed-up by</span>
<a name="line-18"></a><a name="MonadConc"></a><span class='hs-comment'>-- forcing evaluation in separate threads. @MonadConc@ doesn't do</span>
<a name="line-19"></a><a name="MonadConc"></a><span class='hs-comment'>-- that, and so you need to be careful about where evaluation occurs,</span>
<a name="line-20"></a><a name="MonadConc"></a><span class='hs-comment'>-- just like with 'MVar's. Secondly, this builds on futures by</span>
<a name="line-21"></a><a name="MonadConc"></a><span class='hs-comment'>-- allowing @CVar@s which threads can read from and write to, possibly</span>
<a name="line-22"></a><a name="MonadConc"></a><span class='hs-comment'>-- multiple times, whereas with the @Par@ monads it is illegal to</span>
<a name="line-23"></a><a name="MonadConc"></a><span class='hs-comment'>-- write multiple times to the same @IVar@ (or to non-blockingly read</span>
<a name="line-24"></a><a name="MonadConc"></a><span class='hs-comment'>-- from it), which removes the possibility of data races.</span>
<a name="line-25"></a><a name="MonadConc"></a><span class='hs-comment'>--</span>
<a name="line-26"></a><a name="MonadConc"></a><span class='hs-comment'>-- A minimal implementation consists of 'fork', 'newEmptyCVar',</span>
<a name="line-27"></a><a name="MonadConc"></a><span class='hs-comment'>-- 'tryPutCVar', and 'tryTakeCVar'. The default implementations of</span>
<a name="line-28"></a><a name="MonadConc"></a><span class='hs-comment'>-- 'takeCVar' and 'putCVar', however, are very inefficient, and should</span>
<a name="line-29"></a><a name="MonadConc"></a><span class='hs-comment'>-- probably always be overridden to make use of</span>
<a name="line-30"></a><a name="MonadConc"></a><span class='hs-comment'>-- implementation-specific blocking functionality.</span>
<a name="line-31"></a><a name="MonadConc"></a><span class='hs-keyword'>class</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MonadConc</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>where</span>
<a name="line-32"></a>  <span class='hs-comment'>-- | The mutable reference type. This may contain one value at a</span>
<a name="line-33"></a>  <span class='hs-comment'>-- time, attempting to read or take from an \"empty\" @CVar@ will</span>
<a name="line-34"></a>  <span class='hs-comment'>-- block until it is full, and attempting to put to a \"full\"</span>
<a name="line-35"></a>  <span class='hs-comment'>-- @CVar@ will block until it is empty.</span>
<a name="line-36"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>CVar</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>*</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varop'>*</span>
<a name="line-37"></a>
<a name="line-38"></a>  <span class='hs-comment'>-- | Fork a computation to happen concurrently. Communication may</span>
<a name="line-39"></a>  <span class='hs-comment'>-- happen over @CVar@s.</span>
<a name="line-40"></a>  <span class='hs-varid'>fork</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-41"></a>
<a name="line-42"></a>  <span class='hs-comment'>-- | Create a concurrent computation for the provided action, and</span>
<a name="line-43"></a>  <span class='hs-comment'>-- return a @CVar@ which can be used to query the result.</span>
<a name="line-44"></a>  <span class='hs-comment'>--</span>
<a name="line-45"></a>  <span class='hs-comment'>-- &gt; spawn ma = do</span>
<a name="line-46"></a>  <span class='hs-comment'>-- &gt;   cvar &lt;- newEmptyCVar</span>
<a name="line-47"></a>  <span class='hs-comment'>-- &gt;   fork $ ma &gt;&gt;= putCVar cvar</span>
<a name="line-48"></a>  <span class='hs-comment'>-- &gt;   return cvar</span>
<a name="line-49"></a>  <span class='hs-varid'>spawn</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>CVar</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-50"></a>  <span class='hs-varid'>spawn</span> <span class='hs-varid'>ma</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-51"></a>    <span class='hs-varid'>cvar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEmptyCVar</span>
<a name="line-52"></a>    <span class='hs-varid'>fork</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ma</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>putCVar</span> <span class='hs-varid'>cvar</span>
<a name="line-53"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>cvar</span>
<a name="line-54"></a>
<a name="line-55"></a>  <span class='hs-comment'>-- | Create a new empty @CVar@.</span>
<a name="line-56"></a>  <span class='hs-varid'>newEmptyCVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>CVar</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-57"></a>
<a name="line-58"></a>  <span class='hs-comment'>-- | Put a value into a @CVar@. If there is already a value there,</span>
<a name="line-59"></a>  <span class='hs-comment'>-- this will block until that value has been taken, at which point</span>
<a name="line-60"></a>  <span class='hs-comment'>-- the value will be stored.</span>
<a name="line-61"></a>  <span class='hs-comment'>--</span>
<a name="line-62"></a>  <span class='hs-comment'>-- &gt; putCVar cvar a = tryPutCVar cvar a &gt;&gt;= \b -&gt; unless b $ putCVar cvar a</span>
<a name="line-63"></a>  <span class='hs-varid'>putCVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CVar</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-64"></a>  <span class='hs-varid'>putCVar</span> <span class='hs-varid'>cvar</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryPutCVar</span> <span class='hs-varid'>cvar</span> <span class='hs-varid'>a</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>b</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putCVar</span> <span class='hs-varid'>cvar</span> <span class='hs-varid'>a</span>
<a name="line-65"></a>
<a name="line-66"></a>  <span class='hs-comment'>-- | Attempt to put a value in a @CVar@, returning 'True' (and</span>
<a name="line-67"></a>  <span class='hs-comment'>-- filling the @CVar@) if there was nothing there, otherwise</span>
<a name="line-68"></a>  <span class='hs-comment'>-- returning 'False'.</span>
<a name="line-69"></a>  <span class='hs-varid'>tryPutCVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CVar</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Bool</span>
<a name="line-70"></a>
<a name="line-71"></a>  <span class='hs-comment'>-- | Block until a value is present in the @CVar@, and then return</span>
<a name="line-72"></a>  <span class='hs-comment'>-- it. As with 'readMVar', this does not \"remove\" the value,</span>
<a name="line-73"></a>  <span class='hs-comment'>-- multiple reads are possible.</span>
<a name="line-74"></a>  <span class='hs-varid'>readCVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CVar</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-75"></a>
<a name="line-76"></a>  <span class='hs-comment'>-- | Take a value from a @CVar@. This \"empties\" the @CVar@,</span>
<a name="line-77"></a>  <span class='hs-comment'>-- allowing a new value to be put in. This will block if there is no</span>
<a name="line-78"></a>  <span class='hs-comment'>-- value in the @CVar@ already, until one has been put.</span>
<a name="line-79"></a>  <span class='hs-comment'>--</span>
<a name="line-80"></a>  <span class='hs-comment'>-- &gt; takeCVar cvar = tryTakeCVar cvar &gt;&gt;= maybe (takeCVar cvar) return</span>
<a name="line-81"></a>  <span class='hs-varid'>takeCVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CVar</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-82"></a>  <span class='hs-varid'>takeCVar</span> <span class='hs-varid'>cvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryTakeCVar</span> <span class='hs-varid'>cvar</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>takeCVar</span> <span class='hs-varid'>cvar</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span>
<a name="line-83"></a>
<a name="line-84"></a>  <span class='hs-comment'>-- | Attempt to take a value from a @CVar@, returning a 'Just' (and</span>
<a name="line-85"></a>  <span class='hs-comment'>-- emptying the @CVar@) if there was something there, otherwise</span>
<a name="line-86"></a>  <span class='hs-comment'>-- returning 'Nothing'.</span>
<a name="line-87"></a>  <span class='hs-varid'>tryTakeCVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CVar</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-88"></a>
<a name="line-89"></a><a name="instance%20MonadConc%20IO"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadConc</span> <span class='hs-conid'>IO</span> <span class='hs-keyword'>where</span>
<a name="line-90"></a>  <span class='hs-keyword'>type</span> <span class='hs-conid'>CVar</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MVar</span>
<a name="line-91"></a>
<a name="line-92"></a>  <span class='hs-varid'>readCVar</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readMVar</span>
<a name="line-93"></a>  <span class='hs-varid'>fork</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>void</span> <span class='hs-varop'>.</span> <span class='hs-varid'>forkIO</span>
<a name="line-94"></a>  <span class='hs-varid'>newEmptyCVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newEmptyMVar</span>
<a name="line-95"></a>  <span class='hs-varid'>putCVar</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>putMVar</span>
<a name="line-96"></a>  <span class='hs-varid'>tryPutCVar</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryPutMVar</span>
<a name="line-97"></a>  <span class='hs-varid'>takeCVar</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeMVar</span>
<a name="line-98"></a>  <span class='hs-varid'>tryTakeCVar</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryTakeMVar</span>
</pre></body>
</html>
