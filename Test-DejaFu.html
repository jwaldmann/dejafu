<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Test.DejaFu</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Test-DejaFu.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="src/Test-DejaFu.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">dejafu-0.0.0.0: Overloadable primitives for testable, potentially non-deterministic, concurrency.</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr></table><p class="caption">Test.DejaFu</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Test cases
</a></li><li><a href="#g:2">Predicates
</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Deterministic testing for concurrent computations.
</p><p>As an example, consider this program, which has two locks and a
 shared variable. Two threads are spawned, which claim the locks,
 update the shared variable, and release the locks. The main thread
 waits for them both to terminate, and returns the final result.
</p><pre> bad :: MonadConc m =&gt; m Int
 bad = do
   a &lt;- newEmptyCVar
   b &lt;- newEmptyCVar

   c &lt;- newCVar 0

   j1 &lt;- spawn $ lock a &gt;&gt; lock b &gt;&gt; modifyCVar_ c (return . succ) &gt;&gt; unlock b &gt;&gt; unlock a
   j2 &lt;- spawn $ lock b &gt;&gt; lock a &gt;&gt; modifyCVar_ c (return . pred) &gt;&gt; unlock a &gt;&gt; unlock b

   takeCVar j1
   takeCVar j2

   takeCVar c
</pre><p>The correct result is 0, as it starts out as 0 and is incremented
 and decremented by threads 1 and 2, respectively. However, note the
 order of acquisition of the locks in the two threads. If thread 2
 pre-empts thread 1 between the acquisition of the locks (or if
 thread 1 pre-empts thread 2), a deadlock situation will arise, as
 thread 1 will have lock <code>a</code> and be waiting on <code>b</code>, and thread 2
 will have <code>b</code> and be waiting on <code>a</code>.
</p><p>Here is what <code>dejafu</code> has to say about it:
</p><pre> &gt; autocheck bad
 [fail] Never Deadlocks (checked: 4)
         [deadlock] S0---------S1-P2--S1-
         [deadlock] S0---------S2-P1--S2-
 [fail] Consistent Result (checked: 3)
         [deadlock] S0---------S1-P2--S1-
         0 S0---------S1--------S2--------S0-----
         [deadlock] S0---------S2-P1--S2-
 False
</pre><p>It identifies the deadlock, and also the possible results the
 computation can produce, and displays a simplified trace leading to
 each failing outcome. It also returns <code>False</code> as there are test
 failures. The automatic testing functionality is good enough if you
 only want to check your computation is deterministic, but if you
 have more specific requirements (or have some expected and
 tolerated level of nondeterminism), you can write tests yourself
 using the <code>dejafu*</code> functions.
</p><p>__Warning:__ If your computation under test does <code>IO</code>, the <code>IO</code>
 will be executed lots of times! Be sure that it is deterministic
 enough not to invalidate your test results.
</p></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><a href="#v:autocheck">autocheck</a> :: (Eq a, Show a) =&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic.html#t:Conc">Conc</a> t a) -&gt; IO Bool</li><li class="src short"><a href="#v:dejafu">dejafu</a> :: (Eq a, Show a) =&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic.html#t:Conc">Conc</a> t a) -&gt; (String, <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a) -&gt; IO Bool</li><li class="src short"><a href="#v:dejafus">dejafus</a> :: (Eq a, Show a) =&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic.html#t:Conc">Conc</a> t a) -&gt; [(String, <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a)] -&gt; IO Bool</li><li class="src short"><a href="#v:autocheckIO">autocheckIO</a> :: (Eq a, Show a) =&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic-IO.html#t:ConcIO">ConcIO</a> t a) -&gt; IO Bool</li><li class="src short"><a href="#v:dejafuIO">dejafuIO</a> :: (Eq a, Show a) =&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic-IO.html#t:ConcIO">ConcIO</a> t a) -&gt; (String, <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a) -&gt; IO Bool</li><li class="src short"><a href="#v:dejafusIO">dejafusIO</a> :: (Eq a, Show a) =&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic-IO.html#t:ConcIO">ConcIO</a> t a) -&gt; [(String, <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a)] -&gt; IO Bool</li><li class="src short"><span class="keyword">data</span>  <a href="#t:Result">Result</a> a = <a href="#v:Result">Result</a> {<ul class="subs"><li><a href="#v:_pass">_pass</a> :: Bool</li><li><a href="#v:_casesChecked">_casesChecked</a> :: Int</li><li><a href="#v:_casesTotal">_casesTotal</a> :: Int</li><li><a href="#v:_failures">_failures</a> :: [(Maybe a, <a href="Test-DejaFu-Deterministic.html#t:Trace">Trace</a>)]</li></ul>}</li><li class="src short"><a href="#v:runTest">runTest</a> :: Eq a =&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a -&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic.html#t:Conc">Conc</a> t a) -&gt; <a href="Test-DejaFu.html#t:Result">Result</a> a</li><li class="src short"><a href="#v:runTest-39-">runTest'</a> :: Eq a =&gt; Int -&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a -&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic.html#t:Conc">Conc</a> t a) -&gt; <a href="Test-DejaFu.html#t:Result">Result</a> a</li><li class="src short"><a href="#v:runTestIO">runTestIO</a> :: Eq a =&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a -&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic-IO.html#t:ConcIO">ConcIO</a> t a) -&gt; IO (<a href="Test-DejaFu.html#t:Result">Result</a> a)</li><li class="src short"><a href="#v:runTestIO-39-">runTestIO'</a> :: Eq a =&gt; Int -&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a -&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic-IO.html#t:ConcIO">ConcIO</a> t a) -&gt; IO (<a href="Test-DejaFu.html#t:Result">Result</a> a)</li><li class="src short"><span class="keyword">type</span> <a href="#t:Predicate">Predicate</a> a = [(Maybe a, <a href="Test-DejaFu-Deterministic.html#t:Trace">Trace</a>)] -&gt; <a href="Test-DejaFu.html#t:Result">Result</a> a</li><li class="src short"><a href="#v:deadlocksNever">deadlocksNever</a> ::  <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a</li><li class="src short"><a href="#v:deadlocksAlways">deadlocksAlways</a> ::  <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a</li><li class="src short"><a href="#v:deadlocksSometimes">deadlocksSometimes</a> ::  <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a</li><li class="src short"><a href="#v:alwaysSame">alwaysSame</a> :: Eq a =&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a</li><li class="src short"><a href="#v:notAlwaysSame">notAlwaysSame</a> :: Eq a =&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a</li><li class="src short"><a href="#v:alwaysTrue">alwaysTrue</a> ::  (Maybe a -&gt; Bool) -&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a</li><li class="src short"><a href="#v:alwaysTrue2">alwaysTrue2</a> ::  (Maybe a -&gt; Maybe a -&gt; Bool) -&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a</li><li class="src short"><a href="#v:somewhereTrue">somewhereTrue</a> ::  (Maybe a -&gt; Bool) -&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a</li><li class="src short"><a href="#v:somewhereTrue2">somewhereTrue2</a> ::  (Maybe a -&gt; Maybe a -&gt; Bool) -&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a</li></ul></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a name="v:autocheck" class="def">autocheck</a> :: (Eq a, Show a) =&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic.html#t:Conc">Conc</a> t a) -&gt; IO Bool<a href="src/Test-DejaFu.html#autocheck" class="link">Source</a></p><div class="doc"><p>Automatically test a computation. In particular, look for
 deadlocks and multiple return values.
</p></div></div><div class="top"><p class="src"><a name="v:dejafu" class="def">dejafu</a><a href="src/Test-DejaFu.html#dejafu" class="link">Source</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: (Eq a, Show a)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic.html#t:Conc">Conc</a> t a)</td><td class="doc"><p>The computation to test
</p></td></tr><tr><td class="src">-&gt; (String, <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a)</td><td class="doc"><p>The test case, as a (name, predicate) pair.
</p></td></tr><tr><td class="src">-&gt; IO Bool</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Run a test and print the result to stdout, return <code>True</code> if it
 passes.
</p></div></div><div class="top"><p class="src"><a name="v:dejafus" class="def">dejafus</a> :: (Eq a, Show a) =&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic.html#t:Conc">Conc</a> t a) -&gt; [(String, <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a)] -&gt; IO Bool<a href="src/Test-DejaFu.html#dejafus" class="link">Source</a></p><div class="doc"><p>Run a collection of tests, returning <code>True</code> if all pass.
</p></div></div><div class="top"><p class="src"><a name="v:autocheckIO" class="def">autocheckIO</a> :: (Eq a, Show a) =&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic-IO.html#t:ConcIO">ConcIO</a> t a) -&gt; IO Bool<a href="src/Test-DejaFu.html#autocheckIO" class="link">Source</a></p><div class="doc"><p>Variant of <code><a href="Test-DejaFu.html#v:autocheck">autocheck</a></code> for computations which do <code>IO</code>.
</p></div></div><div class="top"><p class="src"><a name="v:dejafuIO" class="def">dejafuIO</a> :: (Eq a, Show a) =&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic-IO.html#t:ConcIO">ConcIO</a> t a) -&gt; (String, <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a) -&gt; IO Bool<a href="src/Test-DejaFu.html#dejafuIO" class="link">Source</a></p><div class="doc"><p>Variant of <code><a href="Test-DejaFu.html#v:dejafu">dejafu</a></code> for computations which do <code>IO</code>.
</p></div></div><div class="top"><p class="src"><a name="v:dejafusIO" class="def">dejafusIO</a> :: (Eq a, Show a) =&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic-IO.html#t:ConcIO">ConcIO</a> t a) -&gt; [(String, <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a)] -&gt; IO Bool<a href="src/Test-DejaFu.html#dejafusIO" class="link">Source</a></p><div class="doc"><p>Variant of <code><a href="Test-DejaFu.html#v:dejafus">dejafus</a></code> for computations which do <code>IO</code>.
</p></div></div><h1 id="g:1">Test cases
</h1><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:Result" class="def">Result</a> a <a href="src/Test-DejaFu.html#Result" class="link">Source</a></p><div class="doc"><p>The results of a test, including information on the number of
 cases checked, and number of total cases. Be careful if using the
 total number of cases, as that value may be very big, and (due to
 laziness) will actually force a lot more computation!.
</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Result" class="def">Result</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:_pass" class="def">_pass</a> :: Bool</dt><dd class="doc"><p>Whether the test passed or not.
</p></dd><dt class="src"><a name="v:_casesChecked" class="def">_casesChecked</a> :: Int</dt><dd class="doc"><p>The number of cases checked.
</p></dd><dt class="src"><a name="v:_casesTotal" class="def">_casesTotal</a> :: Int</dt><dd class="doc"><p>The total number of cases.
</p></dd><dt class="src"><a name="v:_failures" class="def">_failures</a> :: [(Maybe a, <a href="Test-DejaFu-Deterministic.html#t:Trace">Trace</a>)]</dt><dd class="doc"><p>The failed cases, if any.
</p></dd></dl><div class="clear"></div></div></td></tr></table></div><div class="subs instances"><p id="control.i:Result" class="caption collapser" onclick="toggleSection('i:Result')">Instances</p><div id="section.i:Result" class="show"><table><tr><td class="src">Functor <a href="Test-DejaFu.html#t:Result">Result</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">Eq a =&gt; Eq (<a href="Test-DejaFu.html#t:Result">Result</a> a)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">Show a =&gt; Show (<a href="Test-DejaFu.html#t:Result">Result</a> a)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">NFData a =&gt; NFData (<a href="Test-DejaFu.html#t:Result">Result</a> a)</td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><a name="v:runTest" class="def">runTest</a> :: Eq a =&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a -&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic.html#t:Conc">Conc</a> t a) -&gt; <a href="Test-DejaFu.html#t:Result">Result</a> a<a href="src/Test-DejaFu.html#runTest" class="link">Source</a></p><div class="doc"><p>Run a predicate over all executions with two or fewer
 pre-emptions, and attempt to shrink any failing traces. A
 pre-emption is a context switch where the old thread was still
 runnable.
</p><p>In the resultant traces, a pre-emption is displayed as &quot;Px&quot;,
 where <code>x</code> is the ID of the thread being switched to, whereas a
 regular context switch is displayed as &quot;Sx&quot; (for &quot;start&quot;).
</p></div></div><div class="top"><p class="src"><a name="v:runTest-39-" class="def">runTest'</a> :: Eq a =&gt; Int -&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a -&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic.html#t:Conc">Conc</a> t a) -&gt; <a href="Test-DejaFu.html#t:Result">Result</a> a<a href="src/Test-DejaFu.html#runTest%27" class="link">Source</a></p><div class="doc"><p>Variant of <code><a href="Test-DejaFu.html#v:runTest">runTest</a></code> which takes a pre-emption bound.
</p></div></div><div class="top"><p class="src"><a name="v:runTestIO" class="def">runTestIO</a> :: Eq a =&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a -&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic-IO.html#t:ConcIO">ConcIO</a> t a) -&gt; IO (<a href="Test-DejaFu.html#t:Result">Result</a> a)<a href="src/Test-DejaFu.html#runTestIO" class="link">Source</a></p><div class="doc"><p>Variant of <code><a href="Test-DejaFu.html#v:runTest">runTest</a></code> for computations which do <code>IO</code>.
</p></div></div><div class="top"><p class="src"><a name="v:runTestIO-39-" class="def">runTestIO'</a> :: Eq a =&gt; Int -&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a -&gt; (<span class="keyword">forall</span> t.  <a href="Test-DejaFu-Deterministic-IO.html#t:ConcIO">ConcIO</a> t a) -&gt; IO (<a href="Test-DejaFu.html#t:Result">Result</a> a)<a href="src/Test-DejaFu.html#runTestIO%27" class="link">Source</a></p><div class="doc"><p>Variant of <code><a href="Test-DejaFu.html#v:runTest-39-">runTest'</a></code> for computations which do <code>IO</code>.
</p></div></div><h1 id="g:2">Predicates
</h1><div class="top"><p class="src"><span class="keyword">type</span> <a name="t:Predicate" class="def">Predicate</a> a = [(Maybe a, <a href="Test-DejaFu-Deterministic.html#t:Trace">Trace</a>)] -&gt; <a href="Test-DejaFu.html#t:Result">Result</a> a<a href="src/Test-DejaFu.html#Predicate" class="link">Source</a></p><div class="doc"><p>A <code>Predicate</code> is a function which collapses a list of results
 into a <code><a href="Test-DejaFu.html#t:Result">Result</a></code>.
</p></div></div><div class="top"><p class="src"><a name="v:deadlocksNever" class="def">deadlocksNever</a> ::  <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a<a href="src/Test-DejaFu.html#deadlocksNever" class="link">Source</a></p><div class="doc"><p>Check that a computation never deadlocks.
</p></div></div><div class="top"><p class="src"><a name="v:deadlocksAlways" class="def">deadlocksAlways</a> ::  <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a<a href="src/Test-DejaFu.html#deadlocksAlways" class="link">Source</a></p><div class="doc"><p>Check that a computation always deadlocks.
</p></div></div><div class="top"><p class="src"><a name="v:deadlocksSometimes" class="def">deadlocksSometimes</a> ::  <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a<a href="src/Test-DejaFu.html#deadlocksSometimes" class="link">Source</a></p><div class="doc"><p>Check that a computation deadlocks at least once.
</p></div></div><div class="top"><p class="src"><a name="v:alwaysSame" class="def">alwaysSame</a> :: Eq a =&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a<a href="src/Test-DejaFu.html#alwaysSame" class="link">Source</a></p><div class="doc"><p>Check that the result of a computation is always the same. In
 particular this means either: (a) it always deadlocks, or (b) the
 result is always <code>Just</code> <code>x</code>, for some fixed <code>x</code>.
</p></div></div><div class="top"><p class="src"><a name="v:notAlwaysSame" class="def">notAlwaysSame</a> :: Eq a =&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a<a href="src/Test-DejaFu.html#notAlwaysSame" class="link">Source</a></p><div class="doc"><p>Check that the result of a computation is not always the same.
</p></div></div><div class="top"><p class="src"><a name="v:alwaysTrue" class="def">alwaysTrue</a> ::  (Maybe a -&gt; Bool) -&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a<a href="src/Test-DejaFu.html#alwaysTrue" class="link">Source</a></p><div class="doc"><p>Check that the result of a unary boolean predicate is always
 true.
</p></div></div><div class="top"><p class="src"><a name="v:alwaysTrue2" class="def">alwaysTrue2</a> ::  (Maybe a -&gt; Maybe a -&gt; Bool) -&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a<a href="src/Test-DejaFu.html#alwaysTrue2" class="link">Source</a></p><div class="doc"><p>Check that the result of a binary boolean predicate is always
 true between adjacent pairs of results. In general, it is probably
 best to only check properties here which are transitive and
 symmetric, in order to draw conclusions about the entire collection
 of executions.
</p><p>If the predicate fails, <em>both</em> (result,trace) tuples will be added
 to the failures list.
</p></div></div><div class="top"><p class="src"><a name="v:somewhereTrue" class="def">somewhereTrue</a> ::  (Maybe a -&gt; Bool) -&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a<a href="src/Test-DejaFu.html#somewhereTrue" class="link">Source</a></p><div class="doc"><p>Check that the result of a unary boolean predicate is true at
 least once.
</p></div></div><div class="top"><p class="src"><a name="v:somewhereTrue2" class="def">somewhereTrue2</a> ::  (Maybe a -&gt; Maybe a -&gt; Bool) -&gt; <a href="Test-DejaFu.html#t:Predicate">Predicate</a> a<a href="src/Test-DejaFu.html#somewhereTrue2" class="link">Source</a></p><div class="doc"><p>Check that the result of a binary boolean predicate is true
 between at least one adjacent pair of results. In general, it is
 probably best to only check properties here which are transitive
 and symmetric, in order to draw conclusions about the entire
 collection of executions.
</p><p>If the predicate fails, <em>both</em> (result,trace) tuples will be added
 to the failures list.
</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.13.2.1</p></div></body></html>